[gcode_macro PRINT_START]
gcode:
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_GCODE_OFFSET Z=0

  G28
  G90
  BED_MESH_CLEAR

  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"
    M106 S255

    G1 X{x_wait} Y{y_wait} Z15 F9000
    M190 S{target_bed}

  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"
    G1 X{x_wait} Y{y_wait} Z15 F9000
    M190 S{target_bed}
    SET_DISPLAY_TEXT MSG="Soak for 5 min"
    G4 P300000
  {% endif %}

  SET_DISPLAY_TEXT MSG="Hotend: 150c"
  M109 S150

  G28 Z METHOD=CONTACT CALIBRATE=1

  SET_DISPLAY_TEXT MSG="Leveling"
  Z_TILT_ADJUST
  G28 Z
  SET_DISPLAY_TEXT MSG="Bed mesh"
  BED_MESH_CALIBRATE ADAPTIVE=1

  G28 Z METHOD=CONTACT CALIBRATE=0

  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M107
  M109 S{target_extruder}

  SET_GCODE_OFFSET Z=0.06

  SET_DISPLAY_TEXT MSG="Printer goes brr"
  G0 X{x_wait - 50} Y4 F10000
  G0 Z0.4
  G91
  G1 X100 E20 F1000
  G90
  
[gcode_macro LOAD_FILAMENT]
variable_ignore_min_extrude_temp: True
gcode:
  M117 Loading
  M104 S240
  G90
  G1 X100 Y20 Z20 F1800
  M104 S240
  TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
  M83
  G1 E50 F300
  G1 E50 F300
  G1 E-4 F1800
  M82
  M400
  M104 S0
  M117 Loading done

[gcode_macro UNLOAD_FILAMENT]
variable_ignore_min_extrude_temp: True
gcode:
  M117 Unloading
  M104 S240
  TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
  M83
  G1 E5 F500
  G1 E-50 F1000
  G1 E-50 F1000
  M82
  M400
  TURN_OFF_HEATERS
  M117 Unloading done